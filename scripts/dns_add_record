#!/bin/bash

a_record() {
	name=$1
	address=$2
	zone=$3
	serial=$(cat /etc/bind/mrt-zones/db.$zone | grep -P 'Serial' | grep -oP '\d+')
	nextSerial=$(($serial + 1))

	# Add A record
	echo "$name	IN	A	$address" >> /etc/bind/mrt-zones/db.$zone;
	sed -i "s/$serial\t\t;\sSerial/$nextSerial\t\t; Serial/" /etc/bind/mrt-zones/db.$zone
	sudo systemctl restart named.service
}

cname_record() {
	alias=$1
	zone=$2
	serial=$(cat /etc/bind/mrt-zones/db.$zone | grep -P 'Serial' | grep -oP '\d+')
        nextSerial=$(($serial + 1))

	# Add CNAME record
	echo "$alias	IN	CNAME	$zone." >> /etc/bind/mrt-zones/db.$zone;
	sed -i "s/$serial\t\t;\sSerial/$nextSerial\t\t; Serial/" /etc/bind/mrt-zones/db.$zone
	sudo systemctl restart named.service
}

mx_record() {
	mail=$1
	address=$2
	zone=$3
	serial=$(cat /etc/bind/mrt-zones/db.$zone | grep -P 'Serial' | grep -oP '\d+')
        nextSerial=$(($serial + 1))

	# Add MX and A record
	echo "@		IN	MX	10	$mail.$zone." >> /etc/bind/mrt-zones/db.$zone;
	echo "$mail	IN	A	$address" >> /etc/bind/mrt-zones/db.$zone;
	sed -i "s/$serial\t\t;\sSerial/$nextSerial\t\t; Serial/" /etc/bind/mrt-zones/db.$zone
        sudo systemctl restart named.service
}

t_option_used=false
while getopts ":t:" opt; do
	case $opt in
	t)
		record_type=$OPTARG
		t_option_used=true
		case $record_type in

			A)
				a_record "$3" "$4" "$5"
			;;

			CNAME)
				cname_record "$3" "$4"

			;;

			MX)
				mx_record "$3" "$4" "$5"
			;;

			*)
				echo "Invalid record type: $record_type"
				exit 1
			;;

		esac
	;;
	\?)
		echo "Invalid option: -$OPTARG"
		exit 1
	;;
	esac
done

if ! $t_option_used; then
	a_record "$1" "$2" "$3"
fi
